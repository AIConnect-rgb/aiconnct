<article class="p-4 border-b border-slate-700/50 flex items-start gap-4 transition-all duration-200"
         [class.is-speaking]="isAnythingSpeakingOnThisPost()">
  <img [src]="post().avatarUrl" alt="User avatar" class="w-12 h-12 rounded-full flex-shrink-0">
  <div class="w-full">
    <div class="flex items-center gap-2">
      <span class="font-bold text-white">{{ post().author }}</span>
      <span class="text-slate-500">{{ post().handle }}</span>
      <span class="text-slate-500">Â·</span>
      <span class="text-slate-500 text-sm">{{ post().timestamp | date:'shortTime' }}</span>
    </div>
    
    <div class="flex items-start justify-between gap-4">
       <p class="text-slate-200 mt-1 whitespace-pre-wrap flex-grow">{{ post().text }}</p>
       @if (post().analysis) {
        <div class="flex items-center flex-shrink-0 mt-1">
          <button (click)="toggleReadComment()" 
                  title="Read comment aloud"
                  class="p-2 rounded-full text-slate-500 hover:bg-cyan-500/20 hover:text-cyan-400 transition-colors">
            @if (isCommentSpeaking()) {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-cyan-400">
                <path d="M5.5 4.5a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z" />
                <path d="M10 4.5a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z" />
                <path d="M14.5 4.5a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z" />
              </svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 S.2.828 1 1 0 010-1.415z" clip-rule="evenodd" />
              </svg>
            }
          </button>
          <button (click)="sharePost()" 
                  [title]="isCopied() ? t('copiedTooltip') : t('sharePostTooltip')"
                  class="p-2 rounded-full text-slate-500 transition-colors"
                  [class.text-green-400]="isCopied()"
                  [class.hover:bg-cyan-500/20]="!isCopied()"
                  [class.hover:text-cyan-400]="!isCopied()">
            @if(isCopied()) {
              <span class="material-symbols-outlined text-2xl">check</span>
            } @else {
              <span class="material-symbols-outlined text-2xl">share</span>
            }
          </button>
        </div>
      }
    </div>

    @if (post().isAnalyzing) {
      <div class="mt-4 border border-slate-700 rounded-lg p-4 animate-pulse">
         <div class="h-4 bg-slate-700 rounded w-1/4"></div>
         <div class="mt-3 space-y-2">
            <div class="h-3 bg-slate-700 rounded w-full"></div>
            <div class="h-3 bg-slate-700 rounded w-5/6"></div>
         </div>
      </div>
    }

    @if (post().analysis; as analysis) {
      <div class="mt-4 border border-slate-700/80 rounded-lg overflow-hidden">
        <div class="bg-slate-800/40 p-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold text-slate-200">{{ t('aiAnalysis') }}</h4>
            <button (click)="toggleChatVisibility()" 
                    [title]="t('toggleChat')"
                    class="p-2 rounded-full hover:bg-slate-700 transition-colors text-slate-400">
              @if(isChatVisible()) {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                  <path fill-rule="evenodd" d="M14.77 12.79a.75.75 0 0 1-1.06-.02L10 8.832 6.29 12.77a.75.75 0 1 1-1.08-1.04l4.25-4.5a.75.75 0 0 1 1.08 0l4.25 4.5a.75.75 0 0 1-.02 1.06Z" clip-rule="evenodd" />
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.168l3.71-3.938a.75.75 0 1 1 1.08 1.04l-4.25 4.5a.75.75 0 0 1-1.08 0l-4.25-4.5a.75.75 0 0 1 .02-1.06Z" clip-rule="evenodd" />
                </svg>
              }
            </button>
          </div>
          @for (insight of analysis.top_insights; track insight.user_id) {
            <div class="mt-2">
              <div class="flex justify-between items-start gap-4">
                  <div>
                    <p class="text-slate-300 italic">"{{ insight.summary }}"</p>
                  </div>
                  <div [class]="'px-3 py-1 text-sm text-nowrap font-bold rounded-full ' + getScoreColor(insight.innovation_score)">
                      {{ t('innovation') }}: {{ insight.innovation_score }}/10
                  </div>
              </div>
              <div class="mt-3 flex items-center flex-wrap gap-x-4 gap-y-2 text-sm">
                  <div class="flex items-center gap-2">
                    <span class="text-slate-400">{{ t('sentiment') }}:</span>
                    <span class="font-semibold text-slate-200">{{ analysis.summary_metrics.predominant_sentiment }}</span>
                  </div>
                  @if (insight.ip_flag) {
                    <div class="inline-flex items-center gap-2 bg-amber-500/20 text-amber-300 text-xs font-medium px-2.5 py-1 rounded-full">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M8 1.75a.75.75 0 0 1 .692.462l1.41 3.393 3.663.293a.75.75 0 0 1 .428 1.317l-2.795 2.52.823 3.731a.75.75 0 0 1-1.1.814L8 12.232l-3.12 1.83a.75.75 0 0 1-1.1-.814l.822-3.73-2.795-2.521a.75.75 0 0 1 .428-1.318l3.663-.293 1.41-3.393A.75.75 0 0 1 8 1.75Z" clip-rule="evenodd" /></svg>
                      {{ t('potentialIP') }}
                    </div>
                  }
              </div>
            </div>
          }
        </div>
        @if(isChatVisible()) {
          <div class="border-t border-slate-700/80 bg-slate-800/20 p-4">
            <div class="flex items-center gap-2 mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-slate-400 flex-shrink-0">
                <path fill-rule="evenodd" d="M10 2c-4.418 0-8 3.134-8 7 0 2.034.934 3.845 2.42 5.055a.75.75 0 0 0 .96-.055l.018-.018a.75.75 0 0 0 .056-.962A6.51 6.51 0 0 1 4 9c0-3.038 2.686-5.5 6-5.5s6 2.462 6 5.5c0 1.258-.474 2.4-1.295 3.258a.75.75 0 0 0 .962.056l.018.018a.75.75 0 0 0 .055-.96A7.962 7.962 0 0 0 18 9c0-3.866-3.582-7-8-7Z" clip-rule="evenodd" />
                <path d="M6.25 12a.75.75 0 0 1 .75-.75h6a.75.75 0 0 1 0 1.5H7a.75.75 0 0 1-.75-.75Z" />
              </svg>
              <h4 class="font-semibold text-slate-200">{{ t('aiChat') }}</h4>
            </div>

            <div class="space-y-4">
              @for(message of chatHistory(); track message.id) {
                <div class="flex items-start gap-3" [class.flex-row-reverse]="message.author === 'user'">
                  @if(message.author === 'ai') {
                    <div class="w-8 h-8 rounded-full bg-cyan-500/20 flex items-center justify-center flex-shrink-0">
                      <svg class="w-5 h-5 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" /></svg>
                    </div>
                  }
                  <div class="flex items-end gap-2" [class.flex-row-reverse]="message.author === 'user'">
                    <div class="p-3 rounded-2xl max-w-sm" [class.bg-slate-700]="message.author === 'ai'" [class.bg-cyan-600]="message.author === 'user'">
                      @if(message.replyingToText) {
                        <div class="mb-2 p-2 border-l-2 bg-black/20 rounded-md text-sm opacity-80"
                             [class.border-cyan-400/50]="message.author === 'user'"
                             [class.border-slate-500/50]="message.author === 'ai'">
                          <p class="line-clamp-2 italic">"{{ message.replyingToText }}"</p>
                        </div>
                      }
                      <p class="text-slate-200 leading-relaxed">{{ message.text }}</p>
                    </div>
                    <button (click)="toggleReadMessage(message)" 
                        title="Read message aloud"
                        class="p-2 rounded-full text-slate-500 hover:bg-cyan-500/20 hover:text-cyan-400 transition-colors flex-shrink-0">
                        @if (isMessageSpeaking(message.id)()) {
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-cyan-400"><path d="M5.5 4.5a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z" /><path d="M10 4.5a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z" /><path d="M14.5 4.5a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z" /></svg>
                        } @else {
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" /></svg>
                        }
                    </button>
                    @if(message.author === 'ai' && isAuthenticated()) {
                       <button (click)="replyToMessage(message)" 
                                [title]="t('replyToMessageTooltip')"
                                class="p-2 rounded-full text-slate-500 hover:bg-cyan-500/20 hover:text-cyan-400 transition-colors flex-shrink-0">
                           <span class="material-symbols-outlined text-xl">reply</span>
                       </button>
                    }
                  </div>
                </div>
              }
              @if(isReplying()) {
                 <div class="flex items-start gap-3">
                   <div class="w-8 h-8 rounded-full bg-cyan-500/20 flex items-center justify-center flex-shrink-0">
                      <svg class="w-5 h-5 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" /></svg>
                    </div>
                   <div class="p-3 rounded-2xl bg-slate-700">
                      <div class="flex items-center justify-center gap-2">
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.3s]"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.15s]"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></span>
                      </div>
                   </div>
                 </div>
              }
            </div>
            
            @if(replyingTo(); as messageToReply) {
              <div class="mt-4 mb-2 p-2 bg-slate-600/50 border-l-4 border-cyan-500 rounded-r-lg text-sm text-slate-300">
                <div class="flex justify-between items-center">
                  <span>{{ t('replyingToAI') }}</span>
                  <button (click)="cancelReply()" class="p-1 rounded-full hover:bg-slate-500/50">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                  </button>
                </div>
                <p class="mt-1 line-clamp-2 italic">"{{ messageToReply.text }}"</p>
              </div>
            }
            @if (isAuthenticated()) {
              <div #chatInputContainer class="mt-4 flex items-center gap-3">
                <textarea #chatInputEl rows="1" [placeholder]="t('replyToAI')" 
                          [value]="chatInputText()"
                          (input)="chatInputText.set($event.target.value)"
                          (keydown.enter)="sendChatMessage(); $event.preventDefault()"
                          class="w-full bg-slate-700/80 border border-slate-600 rounded-lg py-2 px-3 placeholder-slate-400 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 resize-none"></textarea>
                <button (click)="sendChatMessage()" [disabled]="isReplying() || !chatInputText().trim()" class="flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full bg-cyan-600 hover:bg-cyan-700 disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.53L8.25 7.622a.75.75 0 011.06 1.06l-1.954 1.954a.75.75 0 00.53.95l4.95 1.414a.75.75 0 00.95-.826L13.16 3.105a.75.75 0 00-1.06-1.06L3.105 2.289z" />
                  </svg>
                </button>
              </div>
            } @else {
              <div class="mt-4">
                <button (click)="requestLogin()" class="w-full text-center p-3 bg-slate-700/80 hover:bg-slate-700 rounded-lg border border-slate-600 transition-colors">
                    <span class="text-slate-300 font-medium">{{ t('signInToReply') }}</span>
                </button>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>
</article>
